# AcidTest GitHub Action Template
# Copy this file to your skill/MCP server repository as .github/workflows/acidtest.yml
# Automatically scans for security issues on every PR

name: Security Scan

on:
  pull_request:
  push:
    branches: [main, master]

jobs:
  acidtest:
    name: AcidTest Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run AcidTest
        run: |
          # Detect if we're scanning the acidtest repo itself
          if [ -d "test-fixtures" ] && [ -f "src/scanner.ts" ]; then
            echo "üì¶ Detected acidtest repository - scanning test fixtures"
            npx acidtest@latest scan-all test-fixtures --json > results.json

            # For scan-all, check if array is empty or has errors
            if [ "$(jq '. | length' results.json)" -eq 0 ]; then
              echo "‚ùå No fixtures found to scan"
              exit 1
            fi

            # Check for any failures in the array
            FAILURES=$(jq '[.[] | select(.status == "FAIL" or .status == "DANGER")] | length' results.json)

            echo "üõ°Ô∏è AcidTest Results (Test Fixtures)"
            jq -r '.[] | "  \(.skill.name): \(.status) (\(.score)/100)"' results.json

            if [ "$FAILURES" -gt 0 ]; then
              echo ""
              echo "‚ùå $FAILURES fixture(s) failed"
              exit 1
            fi

            echo ""
            echo "‚úÖ All fixtures passed"
          else
            # Standard scan for skill/MCP repositories
            npx acidtest@latest scan . --json > results.json

            # Check for error status
            STATUS=$(jq -r '.status' results.json)

            if [ "$STATUS" = "ERROR" ]; then
              ERROR_MSG=$(jq -r '.error' results.json)
              echo "‚ùå Error: $ERROR_MSG"
              exit 1
            fi

            # Parse results
            SCORE=$(jq -r '.score' results.json)

            echo "üõ°Ô∏è AcidTest Results"
            echo "Score: $SCORE/100"
            echo "Status: $STATUS"
            echo ""

            # Display findings
            jq -r '.findings[] | "  [\(.severity)] \(.title)"' results.json || true

            # Fail on FAIL or DANGER status
            if [ "$STATUS" = "FAIL" ] || [ "$STATUS" = "DANGER" ]; then
              echo ""
              echo "‚ùå Security scan failed"
              exit 1
            fi

            echo ""
            echo "‚úÖ Security scan passed"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acidtest-results
          path: results.json
