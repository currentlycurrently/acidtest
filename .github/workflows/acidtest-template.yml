# AcidTest GitHub Action Template
# Copy this file to your skill/MCP server repository as .github/workflows/acidtest.yml
# Automatically scans for security issues on every PR

name: Security Scan

on:
  pull_request:
  push:
    branches: [main, master]

jobs:
  acidtest:
    name: AcidTest Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: hashFiles('src/scanner.ts') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run AcidTest
        run: |
          # Detect if we're scanning the acidtest repo itself
          if [ -d "test-fixtures" ] && [ -f "src/scanner.ts" ]; then
            echo "üì¶ Detected acidtest repository - testing with fixtures"
            npm install
            npm run build

            # Only scan PASS fixtures for CI (don't fail on test cases designed to fail)
            echo "üõ°Ô∏è Running CI tests on PASS fixtures..."
            node dist/index.js scan test-fixtures/fixture-pass --json > result-pass.json
            node dist/index.js scan test-fixtures/fixture-mcp-pass --json > result-mcp.json

            PASS_STATUS=$(jq -r '.status' result-pass.json)
            MCP_STATUS=$(jq -r '.status' result-mcp.json)

            echo "  fixture-pass: $PASS_STATUS"
            echo "  fixture-mcp-pass: $MCP_STATUS"

            if [ "$PASS_STATUS" != "PASS" ] || [ "$MCP_STATUS" != "PASS" ]; then
              echo "‚ùå Expected PASS fixtures to pass"
              exit 1
            fi

            echo "‚úÖ CI tests passed"
          else
            # Standard scan for skill/MCP repositories
            npx acidtest@latest scan . --json > results.json

            # Check for error status
            STATUS=$(jq -r '.status' results.json)

            if [ "$STATUS" = "ERROR" ]; then
              ERROR_MSG=$(jq -r '.error' results.json)
              echo "‚ùå Error: $ERROR_MSG"
              exit 1
            fi

            # Parse results
            SCORE=$(jq -r '.score' results.json)

            echo "üõ°Ô∏è AcidTest Results"
            echo "Score: $SCORE/100"
            echo "Status: $STATUS"
            echo ""

            # Display findings
            jq -r '.findings[] | "  [\(.severity)] \(.title)"' results.json || true

            # Fail on FAIL or DANGER status
            if [ "$STATUS" = "FAIL" ] || [ "$STATUS" = "DANGER" ]; then
              echo ""
              echo "‚ùå Security scan failed"
              exit 1
            fi

            echo ""
            echo "‚úÖ Security scan passed"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acidtest-results
          path: results.json
