name: AcidTest Security Scan (PR Comment)

on:
  pull_request:
    paths:
      - '**.ts'
      - '**.js'
      - '**.mjs'
      - '**.cjs'
      - 'SKILL.md'
      - 'mcp.json'
      - 'server.json'
      - 'package.json'

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Needed to comment on PRs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Scan with AcidTest
        id: scan
        continue-on-error: true
        run: |
          # Run scan and save results
          npx acidtest@latest scan . --json > results.json || true

          # Output results for next step
          echo "results<<EOF" >> $GITHUB_OUTPUT
          cat results.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if scan failed
          STATUS=$(jq -r '.status // "ERROR"' results.json)
          if [ "$STATUS" = "FAIL" ] || [ "$STATUS" = "DANGER" ]; then
            echo "scan_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "scan_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let results;

            try {
              const data = fs.readFileSync('results.json', 'utf8');
              results = JSON.parse(data);
            } catch (error) {
              // If parsing failed, create error result
              results = {
                status: 'ERROR',
                error: 'Failed to parse scan results',
                score: 0
              };
            }

            const statusEmoji = {
              'PASS': 'âœ…',
              'WARN': 'âš ï¸',
              'FAIL': 'âŒ',
              'DANGER': 'ðŸ”´',
              'ERROR': 'âš ï¸'
            };

            const statusColor = {
              'PASS': 'ðŸŸ¢',
              'WARN': 'ðŸŸ¡',
              'FAIL': 'ðŸŸ ',
              'DANGER': 'ðŸ”´',
              'ERROR': 'âšª'
            };

            let comment = `## ${statusEmoji[results.status]} AcidTest Security Scan\n\n`;

            if (results.status === 'ERROR') {
              comment += `**Status:** Error during scan\n`;
              comment += `**Message:** ${results.error || 'Unknown error'}\n\n`;
            } else {
              // Score bar
              const score = results.score || 0;
              const bars = Math.floor(score / 10);
              const emptyBars = 10 - bars;
              const scoreBar = 'â–ˆ'.repeat(bars) + 'â–‘'.repeat(emptyBars);

              comment += `**Score:** ${score}/100 ${scoreBar}\n`;
              comment += `**Status:** ${statusColor[results.status]} ${results.status}\n\n`;

              if (results.findings && results.findings.length > 0) {
                // Count by severity
                const counts = {
                  CRITICAL: results.findings.filter(f => f.severity === 'CRITICAL').length,
                  HIGH: results.findings.filter(f => f.severity === 'HIGH').length,
                  MEDIUM: results.findings.filter(f => f.severity === 'MEDIUM').length,
                  LOW: results.findings.filter(f => f.severity === 'LOW').length,
                  INFO: results.findings.filter(f => f.severity === 'INFO').length
                };

                comment += `### Summary\n\n`;
                if (counts.CRITICAL > 0) comment += `- ðŸ”´ **${counts.CRITICAL}** Critical\n`;
                if (counts.HIGH > 0) comment += `- ðŸŸ  **${counts.HIGH}** High\n`;
                if (counts.MEDIUM > 0) comment += `- ðŸŸ¡ **${counts.MEDIUM}** Medium\n`;
                if (counts.LOW > 0) comment += `- ðŸ”µ **${counts.LOW}** Low\n`;
                if (counts.INFO > 0) comment += `- âšª **${counts.INFO}** Info\n`;
                comment += `\n`;

                // Show top 5 findings
                comment += `### Top Findings\n\n`;
                const topFindings = results.findings
                  .filter(f => f.severity === 'CRITICAL' || f.severity === 'HIGH')
                  .slice(0, 5);

                if (topFindings.length > 0) {
                  topFindings.forEach(f => {
                    const emoji = f.severity === 'CRITICAL' ? 'ðŸ”´' : 'ðŸŸ ';
                    comment += `${emoji} **${f.severity}**: ${f.title}\n`;
                    if (f.file && f.line) {
                      comment += `  - \`${f.file}:${f.line}\`\n`;
                    } else if (f.file) {
                      comment += `  - \`${f.file}\`\n`;
                    }
                    if (f.detail) {
                      comment += `  - ${f.detail}\n`;
                    }
                    comment += `\n`;
                  });
                } else {
                  // Show other findings if no CRITICAL/HIGH
                  results.findings.slice(0, 5).forEach(f => {
                    const emoji = f.severity === 'MEDIUM' ? 'ðŸŸ¡' : f.severity === 'LOW' ? 'ðŸ”µ' : 'âšª';
                    comment += `${emoji} **${f.severity}**: ${f.title}\n`;
                    if (f.file && f.line) {
                      comment += `  - \`${f.file}:${f.line}\`\n`;
                    } else if (f.file) {
                      comment += `  - \`${f.file}\`\n`;
                    }
                    comment += `\n`;
                  });
                }

                if (results.findings.length > 5) {
                  comment += `\n<details>\n<summary>Show all ${results.findings.length} findings</summary>\n\n`;
                  results.findings.slice(5).forEach(f => {
                    const emoji = {
                      'CRITICAL': 'ðŸ”´',
                      'HIGH': 'ðŸŸ ',
                      'MEDIUM': 'ðŸŸ¡',
                      'LOW': 'ðŸ”µ',
                      'INFO': 'âšª'
                    }[f.severity] || 'âšª';
                    comment += `${emoji} **${f.severity}**: ${f.title}`;
                    if (f.file) comment += ` (\`${f.file}\`)`;
                    comment += `\n`;
                  });
                  comment += `\n</details>\n`;
                }
              } else {
                comment += '### âœ… No security issues detected!\n\n';
                comment += 'This skill/server appears safe to use.\n';
              }

              if (results.recommendation) {
                comment += `\n### Recommendation\n\n`;
                comment += `${results.recommendation}\n`;
              }
            }

            comment += `\n---\n`;
            comment += `<sub>Scanned with [AcidTest v${results.version || '0.8.0'}](https://github.com/currentlycurrently/acidtest)</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('AcidTest Security Scan')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
